<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>openassay ‚Äî SQL Notebook</title>
  <style>
    :root {
      --bg: #1e1e2e;
      --surface: #262637;
      --surface2: #2d2d44;
      --border: #3a3a55;
      --text: #cdd6f4;
      --text-dim: #6c7086;
      --accent: #89b4fa;
      --accent-dim: #45475a;
      --green: #a6e3a1;
      --red: #f38ba8;
      --yellow: #f9e2af;
      --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .header h1 {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header h1 span { color: var(--accent); }
    .header-actions { display: flex; gap: 8px; }
    .header-status {
      font-size: 12px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .header-status .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--green);
    }
    .header-status .dot.loading { background: var(--yellow); animation: pulse 1s infinite; }
    @keyframes pulse { 50% { opacity: 0.4; } }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 6px;
      padding: 8px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-wrap: wrap;
    }
    .btn {
      padding: 5px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface2);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .btn:hover { background: var(--accent-dim); border-color: var(--accent); }
    .btn.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    .btn.primary:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Notebook */
    .notebook {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Cell */
    .cell {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      transition: border-color 0.15s;
    }
    .cell:focus-within { border-color: var(--accent); }
    .cell-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-dim);
    }
    .cell-num { font-family: var(--font-mono); }
    .cell-actions { display: flex; gap: 4px; }
    .cell-btn {
      padding: 2px 8px;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--text-dim);
      font-size: 11px;
      cursor: pointer;
    }
    .cell-btn:hover { background: var(--accent-dim); color: var(--text); }
    .cell-btn.run { color: var(--green); }
    .cell-btn.run:hover { background: rgba(166, 227, 161, 0.15); }

    /* Editor */
    .cell-editor {
      width: 100%;
      min-height: 60px;
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
      outline: none;
      tab-size: 2;
    }
    .cell-editor::placeholder { color: var(--text-dim); }

    /* Output */
    .cell-output {
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      overflow-x: auto;
    }
    .cell-output.empty { display: none; }
    .cell-output .error {
      color: var(--red);
      font-family: var(--font-mono);
      font-size: 12px;
      white-space: pre-wrap;
    }
    .cell-output .info {
      color: var(--green);
      font-family: var(--font-mono);
      font-size: 12px;
    }
    .cell-output .timing {
      color: var(--text-dim);
      font-size: 11px;
      margin-top: 4px;
    }

    /* Results table */
    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      font-family: var(--font-mono);
    }
    .result-table th {
      background: var(--surface2);
      color: var(--accent);
      padding: 6px 10px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 0;
    }
    .result-table td {
      padding: 4px 10px;
      border-bottom: 1px solid var(--border);
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .result-table tr:hover td { background: var(--surface2); }
    .result-table .null { color: var(--text-dim); font-style: italic; }
    .result-table .num { color: var(--yellow); text-align: right; }
    .row-count {
      color: var(--text-dim);
      font-size: 11px;
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
    }

    /* Chart */
    .cell-chart {
      margin-top: 8px;
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      padding: 0 4px;
    }
    .bar-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .bar {
      width: 100%;
      max-width: 60px;
      background: var(--accent);
      border-radius: 3px 3px 0 0;
      min-height: 2px;
      transition: height 0.3s;
    }
    .bar-label {
      font-size: 10px;
      color: var(--text-dim);
      text-align: center;
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .bar-value {
      font-size: 10px;
      color: var(--text);
      font-family: var(--font-mono);
    }

    /* Import overlay */
    .import-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 16px;
      display: none;
    }
    .import-zone.active { display: block; }
    .import-zone:hover, .import-zone.dragover {
      border-color: var(--accent);
      color: var(--text);
      background: rgba(137, 180, 250, 0.05);
    }
    .import-zone input { display: none; }

    /* Tables sidebar */
    .tables-panel {
      font-size: 12px;
      padding: 8px 0;
    }
    .table-item {
      padding: 4px 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }
    .table-item:hover { background: var(--surface2); }
    .table-item .name { color: var(--accent); font-family: var(--font-mono); }
    .table-item .meta { color: var(--text-dim); }

    /* Add cell button */
    .add-cell {
      display: flex;
      justify-content: center;
      padding: 8px;
    }
    .add-cell button {
      padding: 6px 20px;
      border: 1px dashed var(--border);
      border-radius: 6px;
      background: transparent;
      color: var(--text-dim);
      font-size: 12px;
      cursor: pointer;
    }
    .add-cell button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
  </style>
</head>
<body>

<div class="header">
  <h1>üêò <span>openassay</span> SQL Notebook</h1>
  <div class="header-status">
    <div class="dot loading" id="engine-dot"></div>
    <span id="engine-status">Loading engine...</span>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="exportNotebook()">üíæ Save</button>
    <button class="btn" onclick="document.getElementById('import-file').click()">üìÇ Open</button>
    <button class="btn" onclick="shareNotebook()">üîó Share</button>
  </div>
</div>

<div class="toolbar">
  <button class="btn primary" onclick="runAll()" id="btn-run-all" disabled>‚ñ∂ Run All</button>
  <button class="btn" onclick="addCell()">+ SQL Cell</button>
  <button class="btn" onclick="addMarkdownCell()">+ Markdown</button>
  <button class="btn" onclick="toggleImport()">üìÅ Import Data</button>
  <button class="btn" onclick="showTables()">üìã Tables</button>
  <input type="file" id="import-file" accept=".json,.sql" onchange="importNotebook(event)" style="display:none" />
</div>

<div class="notebook" id="notebook">
  <div class="import-zone" id="import-zone">
    <p>üìÅ Drop CSV, JSON, or Excel files here to import as tables</p>
    <p style="font-size:11px;margin-top:8px;">Or click to browse</p>
    <input type="file" id="data-file" accept=".csv,.json,.tsv,.xlsx" multiple onchange="importFiles(event)" />
  </div>

  <!-- Cells will be added here -->
  <div class="add-cell">
    <button onclick="addCell()">+ Add SQL Cell</button>
  </div>
</div>

<script type="module">
  let worker = null;
  let workerReady = false;
  let workerMsgId = 0;
  const workerCallbacks = new Map();
  let cellCounter = 0;
  const cells = [];

  function initWorker() {
    return new Promise(function (resolve, reject) {
      worker = new Worker("worker.js", { type: "module" });
      worker.onmessage = function (e) {
        const msg = e.data;
        if (msg.type === "ready") {
          workerReady = true;
          resolve();
          return;
        }
        if (msg.type === "init_error") {
          reject(new Error(msg.error));
          return;
        }
        const cb = workerCallbacks.get(msg.id);
        if (cb) {
          workerCallbacks.delete(msg.id);
          if (msg.type === "error") {
            cb.reject(new Error(msg.error));
          } else {
            cb.resolve(msg.data);
          }
        }
      };
      worker.onerror = function (err) {
        reject(err);
      };
    });
  }

  function workerCall(type, extra) {
    return new Promise(function (resolve, reject) {
      const id = ++workerMsgId;
      workerCallbacks.set(id, { resolve: resolve, reject: reject });
      const msg = { type: type, id: id };
      if (extra) {
        Object.keys(extra).forEach(function (k) { msg[k] = extra[k]; });
      }
      worker.postMessage(msg);
    });
  }

  // Engine init
  async function initEngine() {
    try {
      await initWorker();
      workerReady = true;
      document.getElementById('engine-dot').classList.remove('loading');
      document.getElementById('engine-status').textContent = 'Engine ready';
      document.getElementById('btn-run-all').disabled = false;
    } catch (err) {
      document.getElementById('engine-dot').style.background = 'var(--red)';
      document.getElementById('engine-dot').classList.remove('loading');
      document.getElementById('engine-status').textContent = `Failed: ${err.message}`;
    }
  }

  async function sql(query) {
    const json = await workerCall("exec_sql", { sql: query });
    const parsed = JSON.parse(json);
    if (!parsed.ok) return { error: parsed.error || parsed.rendered || 'Unknown error' };
    const results = parsed.results || [];
    return results.length > 0 ? results[results.length - 1] : { rows: [], columns: [] };
  }

  // Expose to global scope
  window.sql = sql;

  // Cell management
  window.addCell = function(content = '', run = false) {
    cellCounter++;
    const id = `cell-${cellCounter}`;
    const cellEl = document.createElement('div');
    cellEl.className = 'cell';
    cellEl.id = id;
    cellEl.innerHTML = `
      <div class="cell-header">
        <span class="cell-num">In [${cellCounter}]</span>
        <div class="cell-actions">
          <button class="cell-btn run" onclick="runCell('${id}')" title="Run (Ctrl+Enter)">‚ñ∂ Run</button>
          <button class="cell-btn" onclick="moveCell('${id}', -1)" title="Move up">‚Üë</button>
          <button class="cell-btn" onclick="moveCell('${id}', 1)" title="Move down">‚Üì</button>
          <button class="cell-btn" onclick="deleteCell('${id}')" title="Delete">‚úï</button>
        </div>
      </div>
      <textarea class="cell-editor" placeholder="-- Write SQL here&#10;SELECT * FROM ..."
                onkeydown="cellKeydown(event, '${id}')">${content}</textarea>
      <div class="cell-output empty" id="${id}-output"></div>
    `;

    const addBtn = document.querySelector('.add-cell');
    document.getElementById('notebook').insertBefore(cellEl, addBtn);
    cells.push(id);

    // Auto-resize
    const textarea = cellEl.querySelector('.cell-editor');
    textarea.addEventListener('input', () => autoResize(textarea));
    autoResize(textarea);

    if (content && run) {
      setTimeout(() => runCell(id), 100);
    }

    return id;
  };

  window.addMarkdownCell = function() {
    cellCounter++;
    const id = `cell-${cellCounter}`;
    const cellEl = document.createElement('div');
    cellEl.className = 'cell';
    cellEl.id = id;
    cellEl.innerHTML = `
      <div class="cell-header">
        <span class="cell-num">Md [${cellCounter}]</span>
        <div class="cell-actions">
          <button class="cell-btn" onclick="deleteCell('${id}')">‚úï</button>
        </div>
      </div>
      <textarea class="cell-editor" placeholder="# Markdown cell&#10;Write notes, documentation..." style="min-height:40px;"></textarea>
    `;
    const addBtn = document.querySelector('.add-cell');
    document.getElementById('notebook').insertBefore(cellEl, addBtn);
    cells.push(id);
  };

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.max(60, el.scrollHeight) + 'px';
  }

  window.cellKeydown = function(e, id) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      runCell(id);
    }
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Enter') {
      e.preventDefault();
      runCell(id);
      addCell();
    }
    // Tab for indent
    if (e.key === 'Tab') {
      e.preventDefault();
      const ta = e.target;
      const start = ta.selectionStart;
      ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(ta.selectionEnd);
      ta.selectionStart = ta.selectionEnd = start + 2;
    }
  };

  window.runCell = async function(id) {
    if (!workerReady) return;
    const cell = document.getElementById(id);
    const editor = cell.querySelector('.cell-editor');
    const output = document.getElementById(`${id}-output`);
    let query = editor.value.trim();

    if (!query) return;

    // @table_name directive: save result as a table
    let saveAs = null;
    const atMatch = query.match(/^@(\w+)\s*\n/);
    if (atMatch) {
      saveAs = atMatch[1];
      query = query.slice(atMatch[0].length).trim();
    }

    output.classList.remove('empty');
    output.innerHTML = '<span class="info">Running...</span>';

    const t0 = performance.now();
    try {
      // Run the query first, then materialise as a table if @name was used
      var result = await sql(query);

      if (saveAs && result && !result.error && result.columns && result.columns.length > 0) {
        // Materialise result into a real table so later cells can reference it
        await sql(`DROP TABLE IF EXISTS "${saveAs}"`);
        const colDefs = result.columns.map(c => `"${c}" text`).join(', ');
        await sql(`CREATE TABLE "${saveAs}" (${colDefs})`);
        if (result.rows && result.rows.length > 0) {
          const valuesStr = result.rows.map(row =>
            '(' + row.map(v => v === null ? 'NULL' : `'${String(v).replace(/'/g, "''")}'`).join(', ') + ')'
          ).join(', ');
          await sql(`INSERT INTO "${saveAs}" VALUES ${valuesStr}`);
        }
      }
      const elapsed = ((performance.now() - t0)).toFixed(1);

      if (result.error) {
        output.innerHTML = `<div class="error">${escapeHtml(result.error)}</div>
          <div class="timing">${elapsed}ms</div>`;
        return;
      }

      const rows = result.rows || [];
      const columns = result.columns || [];

      if (columns.length === 0) {
        const msg = saveAs ? `@${saveAs.toUpperCase()}` : (result.command_tag || 'OK');
        output.innerHTML = `<div class="info">${escapeHtml(msg)}</div>
          <div class="timing">${elapsed}ms</div>`;
        return;
      }

      // Store result for exports
      cell._lastResult = { columns, rows };

      // Render table
      let html = saveAs ? `<div class="info">@${saveAs.toUpperCase()}</div>` : '';
      html += renderTable(columns, rows);

      // Auto-chart if we have 2 columns (label + number) and <= 20 rows
      if (columns.length === 2 && rows.length <= 30 && rows.length > 0) {
        const isNumeric = rows.every(r => !isNaN(parseFloat(r[1])));
        if (isNumeric) {
          html += renderBarChart(rows.map(r => r[0]), rows.map(r => parseFloat(r[1])));
        }
      }

      html += `<div class="row-count">
        <span>${rows.length} row${rows.length !== 1 ? 's' : ''}${saveAs ? ` ‚Üí <b>${saveAs}</b>` : ''}</span>
        <span>
          <button class="cell-btn" onclick="exportResult('${id}','csv')" title="Download CSV">CSV</button>
          <button class="cell-btn" onclick="exportResult('${id}','json')" title="Download JSON">JSON</button>
          <button class="cell-btn" onclick="exportResult('${id}','md')" title="Copy as Markdown">MD</button>
          <button class="cell-btn" onclick="exportResult('${id}','html')" title="Copy as HTML">HTML</button>
          ${elapsed}ms
        </span>
      </div>`;
      output.innerHTML = html;

    } catch (err) {
      output.innerHTML = `<div class="error">${escapeHtml(err.message)}</div>`;
    }
  };

  window.runAll = async function() {
    for (const id of cells) {
      const cell = document.getElementById(id);
      if (cell && cell.querySelector('.cell-editor')) {
        await runCell(id);
      }
    }
  };

  window.deleteCell = function(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
    const idx = cells.indexOf(id);
    if (idx >= 0) cells.splice(idx, 1);
  };

  window.moveCell = function(id, direction) {
    const idx = cells.indexOf(id);
    const newIdx = idx + direction;
    if (newIdx < 0 || newIdx >= cells.length) return;
    [cells[idx], cells[newIdx]] = [cells[newIdx], cells[idx]];
    const notebook = document.getElementById('notebook');
    const el = document.getElementById(id);
    const other = document.getElementById(cells[idx]);
    if (direction < 0) notebook.insertBefore(el, other);
    else notebook.insertBefore(other, el);
  };

  function renderTable(columns, rows) {
    const maxRows = 100;
    const display = rows.slice(0, maxRows);
    let html = '<table class="result-table"><thead><tr>';
    html += columns.map(c => `<th>${escapeHtml(c)}</th>`).join('');
    html += '</tr></thead><tbody>';
    for (const row of display) {
      html += '<tr>';
      html += row.map(v => {
        if (v === null || v === undefined) return '<td class="null">NULL</td>';
        if (!isNaN(v) && v !== '') return `<td class="num">${escapeHtml(String(v))}</td>`;
        return `<td>${escapeHtml(String(v))}</td>`;
      }).join('');
      html += '</tr>';
    }
    html += '</tbody></table>';
    if (rows.length > maxRows) {
      html += `<div style="color:var(--text-dim);font-size:11px;margin-top:4px;">Showing ${maxRows} of ${rows.length} rows</div>`;
    }
    return html;
  }

  function renderBarChart(labels, values) {
    const max = Math.max(...values.map(Math.abs));
    if (max === 0) return '';
    const height = 180;
    let html = '<div class="cell-chart">';
    for (let i = 0; i < labels.length; i++) {
      const h = Math.round((Math.abs(values[i]) / max) * height);
      const color = values[i] >= 0 ? 'var(--accent)' : 'var(--red)';
      html += `<div class="bar-group">
        <span class="bar-value">${formatNumber(values[i])}</span>
        <div class="bar" style="height:${h}px;background:${color}"></div>
        <span class="bar-label" title="${escapeHtml(labels[i])}">${escapeHtml(String(labels[i]))}</span>
      </div>`;
    }
    html += '</div>';
    return html;
  }

  function formatNumber(n) {
    if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return n % 1 === 0 ? n.toString() : n.toFixed(2);
  }

  // Import data files
  window.toggleImport = function() {
    const zone = document.getElementById('import-zone');
    zone.classList.toggle('active');
  };

  window.importFiles = async function(event) {
    const files = event.target.files;
    for (const file of files) {
      await importFile(file);
    }
    document.getElementById('import-zone').classList.remove('active');
  };

  async function importFile(file) {
    const name = file.name.replace(/\.[^.]+$/, '').toLowerCase().replace(/[^a-z0-9_]/g, '_');
    const text = await file.text();

    if (file.name.endsWith('.csv') || file.name.endsWith('.tsv')) {
      await importCSV(name, text, file.name.endsWith('.tsv') ? '\t' : ',');
    } else if (file.name.endsWith('.json')) {
      await importJSON(name, text);
    }
  }

  async function importCSV(tableName, text, sep = ',') {
    const lines = text.split('\n').filter(l => l.trim());
    if (lines.length < 2) return;

    const headers = parseCSVRow(lines[0], sep);
    const colDefs = headers.map(h => `"${h.toLowerCase().replace(/[^a-z0-9_]/g, '_')}" TEXT`).join(', ');

    await sql(`DROP TABLE IF EXISTS "${tableName}"`);
    await sql(`CREATE TABLE "${tableName}" (${colDefs})`);

    // Batch insert
    const batchSize = 200;
    for (let i = 1; i < lines.length; i += batchSize) {
      const batch = lines.slice(i, i + batchSize);
      const values = batch.map(line => {
        const cols = parseCSVRow(line, sep);
        return '(' + cols.map(v => `'${v.replace(/'/g, "''")}'`).join(', ') + ')';
      }).join(', ');
      if (values) await sql(`INSERT INTO "${tableName}" VALUES ${values}`);
    }

    addCell(`-- Imported: ${tableName}\nSELECT * FROM "${tableName}" LIMIT 10;`, true);
  }

  async function importJSON(tableName, text) {
    const data = JSON.parse(text);
    const rows = Array.isArray(data) ? data : [data];
    if (rows.length === 0) return;

    const keys = Object.keys(rows[0]);
    const colDefs = keys.map(k => `"${k.toLowerCase().replace(/[^a-z0-9_]/g, '_')}" TEXT`).join(', ');

    await sql(`DROP TABLE IF EXISTS "${tableName}"`);
    await sql(`CREATE TABLE "${tableName}" (${colDefs})`);

    const batchSize = 200;
    for (let i = 0; i < rows.length; i += batchSize) {
      const batch = rows.slice(i, i + batchSize);
      const values = batch.map(row => {
        return '(' + keys.map(k => {
          const v = row[k];
          if (v === null || v === undefined) return 'NULL';
          return `'${String(v).replace(/'/g, "''")}'`;
        }).join(', ') + ')';
      }).join(', ');
      if (values) await sql(`INSERT INTO "${tableName}" VALUES ${values}`);
    }

    addCell(`-- Imported: ${tableName}\nSELECT * FROM "${tableName}" LIMIT 10;`, true);
  }

  function parseCSVRow(line, sep) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (inQuotes) {
        if (ch === '"' && line[i + 1] === '"') { current += '"'; i++; }
        else if (ch === '"') inQuotes = false;
        else current += ch;
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === sep) { result.push(current.trim()); current = ''; }
        else current += ch;
      }
    }
    result.push(current.trim());
    return result;
  }

  // Show tables
  window.showTables = async function() {
    addCell("SELECT table_name, table_schema FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;", true);
  };

  // Drag & drop
  const notebook = document.getElementById('notebook');
  const importZone = document.getElementById('import-zone');

  notebook.addEventListener('dragover', e => {
    e.preventDefault();
    importZone.classList.add('active', 'dragover');
  });
  notebook.addEventListener('dragleave', () => {
    importZone.classList.remove('dragover');
  });
  notebook.addEventListener('drop', async e => {
    e.preventDefault();
    importZone.classList.remove('dragover');
    for (const file of e.dataTransfer.files) {
      await importFile(file);
    }
    importZone.classList.remove('active');
  });
  importZone.addEventListener('click', () => {
    document.getElementById('data-file').click();
  });

  // Save/Load/Share
  window.exportNotebook = function() {
    const data = {
      version: 1,
      title: 'SQL Notebook',
      cells: cells.map(id => {
        const el = document.getElementById(id);
        if (!el) return null;
        return {
          type: el.querySelector('.cell-num').textContent.startsWith('Md') ? 'markdown' : 'sql',
          content: el.querySelector('.cell-editor').value,
        };
      }).filter(Boolean),
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'notebook.sqlnb';
    a.click();
    URL.revokeObjectURL(url);
  };

  window.importNotebook = async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const text = await file.text();

    if (file.name.endsWith('.sql')) {
      // Import .sql file as cells split by semicolons
      const statements = text.split(';').map(s => s.trim()).filter(Boolean);
      for (const stmt of statements) {
        addCell(stmt + ';');
      }
    } else {
      const data = JSON.parse(text);
      for (const cell of data.cells || []) {
        if (cell.type === 'markdown') addMarkdownCell();
        else addCell(cell.content);
      }
    }
  };

  window.shareNotebook = function() {
    // Encode notebook as URL hash
    const data = cells.map(id => {
      const el = document.getElementById(id);
      return el ? el.querySelector('.cell-editor').value : '';
    }).filter(Boolean);
    const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
    const url = `${location.origin}${location.pathname}#nb=${encoded}`;
    navigator.clipboard.writeText(url).then(() => {
      alert('Link copied to clipboard!');
    });
  };

  // Load from URL hash
  function loadFromHash() {
    const hash = location.hash;
    if (hash.startsWith('#nb=')) {
      try {
        const data = JSON.parse(decodeURIComponent(atob(hash.slice(4))));
        for (const content of data) {
          addCell(content);
        }
        return true;
      } catch {}
    }
    return false;
  }

  // Export functions
  window.exportResult = function(cellId, format) {
    const cell = document.getElementById(cellId);
    if (!cell || !cell._lastResult) return;
    const { columns, rows } = cell._lastResult;

    let content, filename, mime;

    switch (format) {
      case 'csv':
        content = toCSV(columns, rows);
        filename = 'result.csv';
        mime = 'text/csv';
        download(content, filename, mime);
        break;
      case 'json':
        content = toJSON(columns, rows);
        filename = 'result.json';
        mime = 'application/json';
        download(content, filename, mime);
        break;
      case 'md':
        content = toMarkdown(columns, rows);
        navigator.clipboard.writeText(content);
        showToast('Markdown copied to clipboard');
        break;
      case 'html':
        content = toHTML(columns, rows);
        navigator.clipboard.writeText(content);
        showToast('HTML copied to clipboard');
        break;
    }
  };

  function toCSV(columns, rows) {
    const escape = v => {
      if (v === null || v === undefined) return '';
      const s = String(v);
      return s.includes(',') || s.includes('"') || s.includes('\n')
        ? '"' + s.replace(/"/g, '""') + '"' : s;
    };
    return [columns.map(escape).join(','),
      ...rows.map(r => r.map(escape).join(','))
    ].join('\n');
  }

  function toJSON(columns, rows) {
    const data = rows.map(row => {
      const obj = {};
      columns.forEach((col, i) => {
        let v = row[i];
        if (v !== null && !isNaN(v) && v !== '') v = parseFloat(v);
        obj[col] = v;
      });
      return obj;
    });
    return JSON.stringify(data, null, 2);
  }

  function toMarkdown(columns, rows) {
    const widths = columns.map((c, i) => {
      const vals = [c, ...rows.map(r => String(r[i] ?? 'NULL'))];
      return Math.max(...vals.map(v => v.length));
    });
    const pad = (s, w) => s + ' '.repeat(Math.max(0, w - s.length));
    const header = '| ' + columns.map((c, i) => pad(c, widths[i])).join(' | ') + ' |';
    const sep = '| ' + widths.map(w => '-'.repeat(w)).join(' | ') + ' |';
    const body = rows.map(r =>
      '| ' + r.map((v, i) => pad(String(v ?? 'NULL'), widths[i])).join(' | ') + ' |'
    ).join('\n');
    return [header, sep, body].join('\n');
  }

  function toHTML(columns, rows) {
    let html = '<table>\n<thead>\n<tr>';
    html += columns.map(c => `<th>${c}</th>`).join('');
    html += '</tr>\n</thead>\n<tbody>\n';
    for (const row of rows) {
      html += '<tr>' + row.map(v => `<td>${v ?? ''}</td>`).join('') + '</tr>\n';
    }
    html += '</tbody>\n</table>';
    return html;
  }

  function download(content, filename, mime) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function showToast(msg) {
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.cssText = 'position:fixed;bottom:20px;right:20px;background:var(--green);color:var(--bg);padding:8px 16px;border-radius:6px;font-size:13px;z-index:999;animation:fadeout 2s forwards;';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2000);
  }

  function escapeHtml(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // Init
  async function boot() {
    await initEngine();

    if (!loadFromHash()) {
      // Default starter cells
      addCell("-- üêò Welcome to openassay SQL Notebook\n-- Ctrl+Enter to run, Ctrl+Shift+Enter to run & add new cell\n-- Drop CSV/JSON files to import data\n-- Use @name to save a cell's result as a table\n\nSELECT 'Hello, SQL Notebook!' AS message, version() AS engine;");
      addCell("-- Create sample data (or just drop a CSV!)\nCREATE TABLE sales (\n  name TEXT, category TEXT, region TEXT,\n  revenue DOUBLE PRECISION, quarter INT\n);\n\nINSERT INTO sales VALUES\n  ('Alpha', 'Tech', 'North', 150000, 1),\n  ('Beta', 'Finance', 'South', 98000, 1),\n  ('Gamma', 'Tech', 'East', 220000, 2),\n  ('Delta', 'Healthcare', 'North', 175000, 2),\n  ('Epsilon', 'Finance', 'West', 130000, 3),\n  ('Zeta', 'Tech', 'South', 310000, 3),\n  ('Eta', 'Healthcare', 'East', 89000, 4),\n  ('Theta', 'Tech', 'West', 195000, 4),\n  ('Iota', 'Finance', 'North', 142000, 4);");
      addCell("-- Use @name to save results as a reusable table\n-- No CREATE TABLE boilerplate needed!\n@by_category\nSELECT category, SUM(revenue) AS total_revenue,\n       COUNT(*) AS deals,\n       ROUND(AVG(revenue)::numeric, 0) AS avg_deal\nFROM sales\nGROUP BY category\nORDER BY total_revenue DESC;");
      addCell("-- Auto-charts when 2 columns! (label + number)\nSELECT category, total_revenue FROM by_category;");
      addCell("-- Window functions: rank & running totals\nSELECT name, category, revenue,\n       RANK() OVER (PARTITION BY category ORDER BY revenue DESC) AS rank_in_cat,\n       SUM(revenue) OVER (ORDER BY revenue DESC) AS running_total\nFROM sales;");
      addCell("-- Export buttons appear below results ‚Üí CSV, JSON, Markdown, HTML\n-- Click them to download or copy!\n@quarterly\nSELECT quarter AS q, SUM(revenue) AS revenue FROM sales GROUP BY quarter ORDER BY q;");
    }
  }

  boot();
</script>
</body>
</html>
