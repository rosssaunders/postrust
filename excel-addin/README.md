# openassay Excel Add-in

Run PostgreSQL queries over your Excel data — entirely in-browser via WebAssembly.

## How it works

1. **Import** — Select a range or table in Excel; the add-in reads the cells and creates an in-memory SQL table
2. **Query** — Write SQL in the task pane; the query runs locally via the openassay WASM engine
3. **Export** — Send results back to a new Excel sheet

No server, no network calls — everything runs in your browser.

## Quick Start

```bash
# 1. Build the WASM package (from repo root)
wasm-pack build --target web --out-dir excel-addin/pkg --release

# 2. Start the dev server
cd excel-addin
node serve.js

# 3. Open Excel Online (excel.office.com)
#    Insert → Office Add-ins → Upload My Add-in → manifest.xml
```

## Features

- **Full PostgreSQL SQL** — JOINs, CTEs, window functions, aggregates, JSON functions
- **Type inference** — automatically detects numbers, text, booleans, dates from Excel data
- **Batch import** — import selected range, named tables, or all sheets at once
- **Results to sheet** — export query results to a new Excel sheet
- **Ctrl+Enter** — keyboard shortcut to run queries
- **Zero latency** — everything runs locally in WASM, no round-trips

## Example

After importing a sheet named "Sales":

```sql
-- Top 5 customers by total spend
SELECT customer, SUM(amount) as total
FROM sales
GROUP BY customer
ORDER BY total DESC
LIMIT 5;

-- Monthly revenue with running total
SELECT
  date_trunc('month', order_date) as month,
  SUM(amount) as revenue,
  SUM(SUM(amount)) OVER (ORDER BY date_trunc('month', order_date)) as cumulative
FROM sales
GROUP BY 1
ORDER BY 1;
```

## Development

The add-in is a single HTML file (`taskpane.html`) that loads the WASM module.
No build tools, no frameworks — just HTML, CSS, and vanilla JS.

### Files

- `manifest.xml` — Office Add-in manifest (tells Excel where to find the add-in)
- `taskpane.html` — The add-in UI + all logic
- `serve.js` — HTTPS dev server (Office Add-ins require HTTPS)
- `pkg/` — WASM build output (generated by `wasm-pack`)

### Rebuilding WASM

```bash
# From repo root
wasm-pack build --target web --out-dir excel-addin/pkg --release
```

## HTTPS Certificate Trust

The dev server uses a self-signed certificate. Browsers will reject it by default.

**Option A: Add to system trust store (Linux)**
```bash
sudo cp .certs/cert.pem /usr/local/share/ca-certificates/openassay-dev.crt
sudo update-ca-certificates
```

**Option B: Launch Chromium with flag**
```bash
chromium --ignore-certificate-errors
```

**Option C: Manual browser exception**
Navigate to `https://localhost:3000` and accept the certificate warning before using the add-in.

## Excel Online Account Requirements

Sideloading Office Add-ins in Excel Online requires a **Microsoft 365 subscription** (Business or Education) or a Microsoft account with access to OneDrive. Free Microsoft accounts (e.g., `@outlook.com`) can sideload via the manual upload flow:

1. Open [Office on the web](https://office.live.com/) and create/open an Excel workbook
2. Go to **Insert → Office Add-ins → Upload My Add-in**
3. Upload `manifest.xml`

If you see "Something's not right — page temporarily unavailable" when opening Excel Online, this typically indicates:
- The free account doesn't have access to the full Excel Online editor (try creating a workbook from OneDrive instead of excel.office.com directly)
- Try navigating to [onedrive.live.com](https://onedrive.live.com), creating a new Excel workbook there, then sideloading the add-in

## Known Issues

### NUMERIC Floating Point Precision

The engine currently represents all numeric values as either `Int(i64)` or `Float(f64)` — there is no dedicated `NUMERIC`/`DECIMAL` type with arbitrary precision. This means:

```sql
-- Returns 99.94999999999999 instead of 99.95
SELECT SUM(amount * qty) FROM orders;
```

PostgreSQL's `NUMERIC` type uses base-10000 digit arrays for exact decimal arithmetic. Implementing this requires adding a new `ScalarValue::Numeric` variant backed by a proper decimal library (e.g., `rust_decimal` or a custom PG-compatible implementation). This is tracked as a future enhancement.

**Workaround:** Use `ROUND()` to control display precision:
```sql
SELECT ROUND(SUM(amount * qty), 2) FROM orders;
```

## Requirements

- Excel Online or Excel Desktop (Windows/Mac) with Office Add-ins support
- Node.js (for dev server)
- Rust + wasm-pack (to rebuild WASM)
